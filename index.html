<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cleaning App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@100..900&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <h2>DataCleaner</h2>
            </div>
            <div class="history-section">
                <h3>Recent Files</h3>
                <ul>
                    {% for file in file_history %}
                    <li class="history-item" data-filename="{{ file }}">
                        <span class="file-icon">üìÑ</span>
                        <span class="file-name">{{ file }}</span>
                        <a href="{{ url_for('download_file', filename='cleaned_' + file) }}" class="download-link">‚¨áÔ∏è</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="header">
                <h1>Data Cleaning and Preprocessing</h1>
                <p class="subtitle">Upload your data file and select cleaning options</p>
            </div>

            <div class="main-section">
                <form action="/upload" method="post" enctype="multipart/form-data">
                    <div class="upload-section">
                        <div class="upload-box">
                            <label for="file" class="file-label">
                                <div class="upload-icon">üìÅ</div>
                                <span>Drag and drop your file here or click to browse</span>
                                <span class="file-types">Supported formats: CSV, Excel, JSON, Parquet</span>
                            </label>
                            <input type="file" name="file" id="file" accept=".csv, .xlsx, .xls, .json, .parquet" required>
                        </div>
                    </div>
                    
                    <div class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">Processing... <span class="progress-percentage">0%</span></div>
                    </div>

                    <div class="options-section">
                        <h2>Cleaning Options</h2>
                        <div class="format-selection">
                            <h3>Output Format</h3>
                            <select name="output_format" class="format-select">
                                <option value="same">Same as input</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                                <option value="json">JSON</option>
                                <option value="parquet">Parquet</option>
                            </select>
                        </div>
                        <div class="options-grid">
                            <label class="option-card">
                                <input type="checkbox" name="remove_duplicates" checked>
                                <span class="option-icon">üîÑ</span>
                                <span class="option-title">Remove Duplicates</span>
                                <span class="option-description">Remove duplicate rows from the dataset</span>
                            </label>

                            <label class="option-card">
                                <input type="checkbox" name="insert_column">
                                <span class="option-icon">‚ûï</span>
                                <span class="option-title">Insert Column</span>
                                <span class="option-description">Add a new column to the dataset</span>
                            </label>

                            <label class="option-card">
                                <input type="checkbox" name="handle_missing" checked>
                                <span class="option-icon">üîç</span>
                                <span class="option-title">Handle Missing Values</span>
                                <span class="option-description">Clean or remove missing data entries</span>
                            </label>

                            <label class="option-card">
                                <input type="checkbox" name="normalize_text">
                                <span class="option-icon">üìù</span>
                                <span class="option-title">Normalize Text</span>
                                <span class="option-description">Convert to lowercase and remove special characters</span>
                            </label>

                            <label class="option-card">
                                <input type="checkbox" name="trim_whitespace" checked>
                                <span class="option-icon">‚úÇÔ∏è</span>
                                <span class="option-title">Trim Whitespace</span>
                                <span class="option-description">Remove leading and trailing spaces</span>
                            </label>
                        </div>
                        
                        <!-- Column details section -->
                        <div class="column-details">
                            <div class="column-list">
                                <!-- Column rows will be dynamically inserted here -->
                            </div>
                            <div class="new-column-section">
                                <input type="text" name="new_column_name" placeholder="Enter new column name" class="new-column-input">
                                <select name="new_column_type" class="new-column-type">
                                    <option value="empty">Empty column</option>
                                    <option value="constant">Constant value</option>
                                    <option value="index">Index numbers</option>
                                </select>
                                <input type="text" name="new_column_value" placeholder="Enter constant value" class="new-column-value" style="display: none;">
                                <button type="button" class="add-column-btn">
                                    <span class="plus-icon">+</span>
                                    Add Column
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="submit-section">
                        <button type="submit" class="primary-button">
                            <span class="button-icon">üöÄ</span>
                            Process Data
                        </button>
                    </div>
                </form>
            </div>

            <div class="footer">
                <div class="supported-formats">
                    <h3>Supported File Formats</h3>
                    <div class="format-grid">
                        <div class="format-item">
                            <span class="format-icon">üìä</span>
                            <span>CSV</span>
                        </div>
                        <div class="format-item">
                            <span class="format-icon">üìë</span>
                            <span>Excel</span>
                        </div>
                        <div class="format-item">
                            <span class="format-icon">üî†</span>
                            <span>JSON</span>
                        </div>
                        <div class="format-item">
                            <span class="format-icon">üì¶</span>
                            <span>Parquet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add context menu -->
    <div id="contextMenu" class="context-menu">
        <div class="menu-item delete-history">Delete from history</div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const contextMenu = document.getElementById('contextMenu');
        const historyItems = document.querySelectorAll('.history-item');

        // Hide context menu on click outside
        document.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });

        // Prevent default right-click menu and show custom menu
        historyItems.forEach(item => {
            item.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const filename = item.dataset.filename;
                
                // Position the context menu
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                
                // Add click handler for delete option
                const deleteOption = contextMenu.querySelector('.delete-history');
                deleteOption.onclick = async () => {
                    try {
                        const response = await fetch('/delete_history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ filename: filename })
                        });
                        
                        if (response.ok) {
                            item.remove();
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                };
            });
        });

        const form = document.querySelector('form');
        const progressContainer = document.querySelector('.progress-container');
        const progressFill = document.querySelector('.progress-fill');
        const progressText = document.querySelector('.progress-percentage');
        const submitButton = document.querySelector('.primary-button');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            // Disable submit button and show progress
            submitButton.disabled = true;
            progressContainer.style.display = 'block';
            
            try {
                // Start progress animation
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 2;
                    if (progress <= 95) {
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;
                    }
                }, 50);

                // Send form data
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Complete the progress bar
                clearInterval(interval);
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
                
                // Wait 3 seconds then trigger download
                setTimeout(() => {
                    if (result.filename) {
                        // Create download link and trigger it
                        const downloadUrl = `/download_file?filename=cleaned_${result.filename}`;
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = `cleaned_${result.filename}`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    
                    // Reset the progress bar and form
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    submitButton.disabled = false;
                    form.reset();
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                progressContainer.style.display = 'none';
                submitButton.disabled = false;
            }
        });

        // Column insertion handling
        const insertColumnCheckbox = document.querySelector('input[name="insert_column"]');
        const columnDetails = document.querySelector('.column-details');
        const columnValueType = document.querySelector('select[name="column_value_type[]"]');
        const columnValueInput = document.querySelector('input[name="column_value[]"]');

        insertColumnCheckbox.addEventListener('change', function() {
            if (this.checked) {
                columnDetails.style.display = 'block';
                // Use setTimeout to ensure display: block is applied before adding visible class
                setTimeout(() => {
                    columnDetails.classList.add('visible');
                }, 10);
            } else {
                columnDetails.classList.remove('visible');
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    columnDetails.style.display = 'none';
                }, 300);
            }
        });

        columnValueType.addEventListener('change', function() {
            if (this.value === 'constant') {
                columnValueInput.classList.add('visible');
            } else {
                columnValueInput.classList.remove('visible');
            }
        });

        const fileInput = document.querySelector('input[name="file"]');
        const columnList = document.querySelector('.column-list');
        const newColumnInput = document.querySelector('.new-column-input');
        const newColumnType = document.querySelector('.new-column-type');
        const newColumnValue = document.querySelector('.new-column-value');
        const addColumnBtn = document.querySelector('.add-column-btn');

        // Handle file selection
        fileInput.addEventListener('change', async function(e) {
            if (this.files.length > 0) {
                const formData = new FormData();
                formData.append('file', this.files[0]);

                try {
                    const response = await fetch('/get_columns', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.columns) {
                        // Clear existing columns
                        columnList.innerHTML = '';
                        
                        // Add a row for each existing column
                        data.columns.forEach(column => {
                            addColumnRow(column, true);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching columns:', error);
                }
            }
        });

        // Show/hide constant value input based on column type
        newColumnType.addEventListener('change', function() {
            newColumnValue.style.display = this.value === 'constant' ? 'block' : 'none';
        });

        // Add new column button handler
        addColumnBtn.addEventListener('click', () => {
            const columnName = newColumnInput.value.trim();
            
            if (!columnName) {
                alert('Please enter a column name');
                return;
            }

            // Check for duplicate column names
            const existingColumns = Array.from(columnList.querySelectorAll('.column-name')).map(el => el.value);
            if (existingColumns.includes(columnName)) {
                alert('Column name already exists');
                return;
            }

            addColumnRow({
                name: columnName,
                type: newColumnType.value,
                value: newColumnValue.value
            });

            // Clear inputs
            newColumnInput.value = '';
            newColumnValue.value = '';
            newColumnType.value = 'empty';
            newColumnValue.style.display = 'none';
        });

        // Form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            // Add column data to formData
            const columns = Array.from(columnList.querySelectorAll('.column-row')).map(row => ({
                name: row.querySelector('.column-name').value,
                type: row.querySelector('select[name="column_value_type[]"]').value,
                value: row.querySelector('input[name="column_value[]"]').value
            }));

            // Append column data to formData
            formData.append('columns', JSON.stringify(columns));

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Handle success
                    console.log('File processed successfully');
                    // Trigger download or show success message
                } else {
                    // Handle error
                    console.error('Error:', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function addColumnRow(columnData) {
            const columnRow = document.createElement('div');
            columnRow.className = 'column-row';
            
            columnRow.innerHTML = `
                <input type="text" 
                    name="column_name[]" 
                    class="column-name" 
                    value="${columnData.name}" 
                    readonly>
                <select name="column_value_type[]">
                    <option value="empty" ${columnData.type === 'empty' ? 'selected' : ''}>Empty column</option>
                    <option value="constant" ${columnData.type === 'constant' ? 'selected' : ''}>Constant value</option>
                    <option value="index" ${columnData.type === 'index' ? 'selected' : ''}>Index numbers</option>
                </select>
                <input type="text" 
                    name="column_value[]" 
                    class="constant-value" 
                    value="${columnData.type === 'constant' ? columnData.value : ''}"
                    style="display: ${columnData.type === 'constant' ? 'block' : 'none'}">
                <button type="button" class="remove-column-btn">√ó</button>
            `;

            // Add remove button handler
            const removeBtn = columnRow.querySelector('.remove-column-btn');
            removeBtn.addEventListener('click', () => {
                columnRow.remove();
            });

            // Add value type change handler
            const valueTypeSelect = columnRow.querySelector('select[name="column_value_type[]"]');
            const constantValueInput = columnRow.querySelector('input[name="column_value[]"]');
            valueTypeSelect.addEventListener('change', function() {
                constantValueInput.style.display = this.value === 'constant' ? 'block' : 'none';
            });

            columnList.appendChild(columnRow);
        }
    });
    function onProgressComplete() {
    const formatSelection = document.querySelector('.format-selection');
    formatSelection.classList.add('show');
}
    </script>
</body>
</html>
